<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8" />
<title>四半期報告書</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
<script type="text/javascript" src="js/main.js"></script>

<script>
var category_select;
var category_edinet_codes;
var edinet_codes_select;
var selectedCategory = null;


function addCell(row, text, rowspan, colspan){
    if(text == undefined){
        text = '&nbsp;';
    }
    var cell1 = row.insertCell(-1);
    if(rowspan != undefined){
        cell1.rowSpan = rowspan;
    }
    if(colspan != undefined){
        cell1.colSpan = colspan;
    }

    // Add some text to the new cells:
    cell1.innerHTML = text;
}

function tableItem(end_dates, table, obj, nest){
    tab = '&nbsp;'.repeat(4 * nest);

    if(obj['type'] == '文字列' || obj['type'] == 'テキストブロック'){

        var row = table.insertRow(-1);
        addCell(row, tab + 'itm:' + obj['title'], end_dates.length);
        addCell(row, obj['type'], end_dates.length);
        addCell(row, obj['text'][0], undefined, end_dates.length);

        for(var i = 1; i < obj['text'].length; i++){
            row = table.insertRow(-1);
            addCell(row, obj['text'][i], undefined, end_dates.length);
        }
    }
    else{

        var row = table.insertRow(-1);
        addCell(row, tab + 'itm:' + obj['title']);
        addCell(row, obj['type']);
        for(var x of obj['text']){
            addCell(row, x);
        }
    }

    if(obj['children'].length != 0){
        for(var item2 of obj['children']){
            tableItem(end_dates, table, item2, nest + 1)
        }
    }
}

function tableAxis(end_dates, table, obj, nest){
    tab = '&nbsp;'.repeat(4 * nest);

    var row = table.insertRow(-1);
    addCell(row, tab + 'axis:' + obj['axis'], undefined, 1 + 1 + end_dates.length);

    for(var obj2 of obj['members']){
        tableObj(end_dates, table, obj2, nest + 1)
    }
}

function tableObj(end_dates, table, obj, nest){
    tab = '&nbsp;'.repeat(4 * nest);

    if('member' in obj){

        var row = table.insertRow(-1);
        addCell(row, tab + 'mem:' + obj['member'], undefined, 1 + 1 + end_dates.length);
    }

    if('values' in obj && obj['values'].length != 0){
        for(var item of obj['values']){
            tableItem(end_dates, table, item, nest + 1)
        }
    }

    if('axes' in obj && obj['axes'].length != 0){
        for(var axis of obj['axes']){
            tableAxis(end_dates, table, axis, nest + 1)
        }
    }
}

function makeTable(doc){
    var doc_div = document.getElementById('doc-div');
    while (doc_div.firstChild) {
        doc_div.removeChild(doc_div.firstChild);
    }

    // { 'end_dates': end_dates, 'time_objs': time_objs }
    end_dates = doc['end_dates'];
    for(var time_obj of doc['time_objs']){
        console.log(time_obj['time'] + '----------')
        times = [ '当四半期会計期間連結時点', '当四半期会計期間連結期間', '当四半期累計期間連結期間', '当期連結時点', '当期連結期間' ];            
        if(true || times.indexOf( time_obj['time'] ) != -1){

            doc_div.appendChild( document.createElement('hr') );

            h1  = document.createElement('h1');
            h1.innerHTML = time_obj['time'];
            doc_div.appendChild(h1);

            table = document.createElement('table');
            table.border = '1';
            doc_div.appendChild(table);
            // table = document.getElementById(time_obj['time']);

            var header;
            if(table.tHead == null){

                header = table.createTHead();
            }
            else{

                header = table.tHead
                header.deleteRow(0);
            }

            // Create an empty <tr> element and add it to the first position of <thead>:
            var row = header.insertRow(-1);

            // Insert a new cell (<td>) at the first position of the "new" <tr> element:
            var cell = row.insertCell(-1);
            cell.innerHTML = time_obj['time'];

            addCell(row, '単位');

            for(var end_date of end_dates){
                cell = row.insertCell(-1);
                cell.innerHTML = end_date;

            }

            new_tbody = document.createElement('tbody');
            if(table.tBodies.length == 0){
                table.appendChild(new_tbody)
            }
            else{

                var old_tbody = table.tBodies[0];
                old_tbody.parentNode.replaceChild(new_tbody, old_tbody)
            }

            tableObj(end_dates, table, time_obj, 0)
        }

        //'提出日時点'
    }
}

function readXbrl(category_name, edinet_code){
    json_path = '../data/json/四半期報告書/'+ category_name + '/' + edinet_code + '.json'
    $.ajax({ // json読み込み開始
        type: 'GET',
        url: json_path,
        dataType: 'json'
    })
    .then(
        function(doc) { // jsonの読み込みに成功した時
            makeTable(doc);
        },
        function() { //jsonの読み込みに失敗した時
            console.log('失敗');
        }
    );
}

function on_load(){
    drawChart();
    category_select = document.getElementById('category');
    edinet_codes_select = document.getElementById('edinet_codes');

    readXbrl('医薬品', 'E00816');

    json_path = '../data/json/四半期報告書/category_edinet_codes.json'
    $.ajax({ // json読み込み開始
        type: 'GET',
        url: json_path,
        dataType: 'json'
    })
    .then(
        function(time_objs) { // jsonの読み込みに成功した時

            category_edinet_codes = time_objs;

            for(var category of time_objs){
                // option要素の宣言
                var option = document.createElement('option');
                // option要素のvalue属性に値をセット
                // option.setAttribute('value', category['category_name']);
                // option要素に値をセット
                option.innerHTML = category['category_name'];
                // 作成したoption要素をselectタグに追加
                category_select.appendChild(option);
            }

        },
        function() { //jsonの読み込みに失敗した時
            console.log('失敗');
        }
    );
}

function category_changed(){
    $('#edinet_codes').empty()

    var idx = category_select.selectedIndex;
    if(idx == -1){
        selectedCategory = null;
        return;
    }

    selectedCategory = category_edinet_codes[idx];

    for(var edinet_code of selectedCategory['edinet_codes']){
            // option要素の宣言
            var option = document.createElement('option');
            // option要素のvalue属性に値をセット
            // option.setAttribute('value', category['category_name']);
            // option要素に値をセット
            option.innerHTML = edinet_code;
            // 作成したoption要素をselectタグに追加
            edinet_codes_select.appendChild(option);
    }
}

function edinet_codes_changed(){

    var idx = edinet_codes_select.selectedIndex;
    if(idx == -1){
        return;
    }

    category_name = selectedCategory['category_name']
    edinet_code = selectedCategory['edinet_codes'][idx];

    readXbrl(category_name, edinet_code);
}

function drawChart(){
//「月別データ」
var mydata = {
  labels: ["１月", "２月", "３月", "４月", "５月", "６月", "７月"],
  datasets: [
    {
      label: '数量',
      hoverBackgroundColor: "rgba(255,99,132,0.3)",
      data: [65, 59, 80, 81, 56, 55, 48],
    }
  ]
};

//「オプション設定」
var options = {
    title: {    
        display: true,
        text: 'サンプルチャート'
    }
};

var canvas = document.getElementById('stage');
var chart = new Chart(canvas, {
    type: 'bar',  //グラフの種類
    data: mydata,  //表示するデータ
    options: options  //オプション設定
});

}

</script>    
</head>
<body onload="on_load()">
<canvas id="stage"></canvas>
<ul id="demo"></ul>

<select id='category' size="10" onchange="category_changed()"></select>
<select id='edinet_codes' size="10" onchange="edinet_codes_changed()"></select>

<div id='doc-div'></div>
</body>
</html>